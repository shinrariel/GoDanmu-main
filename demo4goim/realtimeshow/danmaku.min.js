(function(t,i){typeof exports==="object"&&typeof module!=="undefined"?module.exports=i():typeof define==="function"&&define.amd?define(i):t.Danmaku=i()})(this,function(){"use strict";function t(t){var i=this;var e=this._hasMedia?this.media.currentTime:Date.now()/1e3;var s=this._hasMedia?this.media.playbackRate:1;function n(t,n){if(n.mode==="top"||n.mode==="bottom"){return e-t.time<i.duration}var h=i.width+t.width;var a=h*(e-t.time)*s/i.duration;if(t.width>a){return true}var r=i.duration+t.time-e;var o=i.width+n.width;var d=o*(e-n.time)*s/i.duration;var u=i.width-d;var m=i.duration*u/(i.width+n.width);return r>m}var h=this._space[t.mode];var a=0;var r=0;for(var o=1;o<h.length;o++){var d=h[o];var u=t.height;if(t.mode==="top"||t.mode==="bottom"){u+=d.height}if(d.range-d.height-h[a].range>=u){r=o;break}if(n(d,t)){a=o}}var m=h[a].range;var l={range:m+t.height,time:this._hasMedia?t.time:t._utc,width:t.width,height:t.height};h.splice(a+1,r-a-1,l);if(t.mode==="bottom"){return this.height-t.height-m%this.height}return m%(this.height-t.height)}function i(t){var i=document.createElement("div");i.style.cssText="position:absolute;";if(typeof t.render==="function"){var e=t.render();if(e instanceof HTMLElement){i.appendChild(e);return i}}if(t.html===true){i.innerHTML=t.text}else{i.textContent=t.text}if(t.style){for(var s in t.style){i.style[s]=t.style[s]}}return i}var e=function(){var t=["oTransform","msTransform","mozTransform","webkitTransform","transform"];var i=document.createElement("div").style;for(var e=0;e<t.length;e++){if(t[e]in i){return t[e]}}return"transform"}();function s(){var s=Date.now()/1e3;var n=this._hasMedia?this.media.currentTime:s;var h=this._hasMedia?this.media.playbackRate:1;var a=null;var r=0;var o=0;for(o=this.runningList.length-1;o>=0;o--){a=this.runningList[o];r=this._hasMedia?a.time:a._utc;if(n-r>this.duration){this.stage.removeChild(a.node);if(!this._hasMedia){a.node=null}this.runningList.splice(o,1)}}var d=[];var u=document.createDocumentFragment();while(this.position<this.comments.length){a=this.comments[this.position];r=this._hasMedia?a.time:a._utc;if(r>=n){break}a._utc=s-(this._hasMedia?this.media.currentTime-a.time:0);a.node=a.node||i(a);this.runningList.push(a);d.push(a);u.appendChild(a.node);++this.position}if(d.length){this.stage.appendChild(u)}for(o=0;o<d.length;o++){a=d[o];a.width=a.width||a.node.offsetWidth;a.height=a.height||a.node.offsetHeight}for(o=0;o<d.length;o++){a=d[o];a.y=t.call(this,a);if(a.mode==="top"||a.mode==="bottom"){a.x=this.width-a.width>>1;a.node.style[e]="translate("+a.x+"px,"+a.y+"px)"}}for(o=0;o<this.runningList.length;o++){a=this.runningList[o];if(a.mode==="top"||a.mode==="bottom"){continue}var m=this.width+a.width;var l=m*(s-a._utc)*h/this.duration;l|=0;if(a.mode==="ltr")a.x=l-a.width;if(a.mode==="rtl")a.x=this.width-l;a.node.style[e]="translate("+a.x+"px,"+a.y+"px)"}}var n=Object.create(null);function h(t,i){if(n[t]){return n[t]}var e=12;var s=/^(\d+(?:\.\d+)?)(px|%|em|rem)(?:\s*\/\s*(\d+(?:\.\d+)?)(px|%|em|rem)?)?/;var h=t.match(s);if(h){var a=h[1]*1||10;var r=h[2];var o=h[3]*1||1.2;var d=h[4];if(r==="%")a*=i.container/100;if(r==="em")a*=i.container;if(r==="rem")a*=i.root;if(d==="px")e=o;if(d==="%")e=a*o/100;if(d==="em")e=a*o;if(d==="rem")e=i.root*o;if(d===undefined)e=a*o}n[t]=e;return e}function a(t,i){if(typeof t.render==="function"){var e=t.render();if(e instanceof HTMLCanvasElement){t.width=e.width;t.height=e.height;return e}}var s=document.createElement("canvas");var n=s.getContext("2d");var a=t.canvasStyle||{};a.font=a.font||"10px sans-serif";a.textBaseline=a.textBaseline||"bottom";var r=a.lineWidth*1;r=r>0&&r!==Infinity?Math.ceil(r):!!a.strokeStyle*1;n.font=a.font;t.width=t.width||Math.max(1,Math.ceil(n.measureText(t.text).width)+r*2);t.height=t.height||Math.ceil(h(a.font,i))+r*2;s.width=t.width;s.height=t.height;for(var o in a){n[o]=a[o]}var d=0;switch(a.textBaseline){case"top":case"hanging":d=r;break;case"middle":d=t.height>>1;break;default:d=t.height-r}if(a.strokeStyle){n.strokeText(t.text,r,d)}n.fillText(t.text,r,d);return s}function r(){this.stage.context.clearRect(0,0,this.width,this.height);var i=Date.now()/1e3;var e=this._hasMedia?this.media.currentTime:i;var s=this._hasMedia?this.media.playbackRate:1;var n=null;var h=0;var r=0;for(r=this.runningList.length-1;r>=0;r--){n=this.runningList[r];h=this._hasMedia?n.time:n._utc;if(e-h>this.duration){n.canvas=null;this.runningList.splice(r,1)}}while(this.position<this.comments.length){n=this.comments[this.position];h=this._hasMedia?n.time:n._utc;if(h>=e){break}n._utc=i-(this._hasMedia?this.media.currentTime-n.time:0);n.canvas=a(n,this._fontSize);n.y=t.call(this,n);if(n.mode==="top"||n.mode==="bottom"){n.x=this.width-n.width>>1}this.runningList.push(n);++this.position}for(r=0;r<this.runningList.length;r++){n=this.runningList[r];var o=this.width+n.width;var d=o*(i-n._utc)*s/this.duration;if(n.mode==="ltr")n.x=d-n.width+.5|0;if(n.mode==="rtl")n.x=this.width-d+.5|0;this.stage.context.drawImage(n.canvas,n.x,n.y)}}var o=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){return setTimeout(t,50/3)};var d=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||clearTimeout;function u(){if(!this.visible||!this.paused){return this}this.paused=false;if(this._hasMedia){for(var t=0;t<this.runningList.length;t++){var i=this.runningList[t];i._utc=Date.now()/1e3-(this.media.currentTime-i.time)}}var e=this;var n=this._useCanvas?r:s;function h(){n.call(e);e._requestID=o(h)}this._requestID=o(h);return this}function m(){if(!this.visible||this.paused){return this}this.paused=true;d(this._requestID);this._requestID=0;return this}function l(t,i,e){var s=0;var n=0;var h=t.length;while(n<h-1){s=n+h>>1;if(e>=t[s][i]){n=s}else{h=s}}if(t[n]&&e<t[n][i]){return n}return h}function c(){var t=9007199254740991;return[{range:0,time:-t,width:t,height:0},{range:t,time:t,width:0,height:0}]}function f(t){t.ltr=c();t.rtl=c();t.top=c();t.bottom=c()}function p(){if(!this._hasMedia){return this}this.clear();f(this._space);var t=l(this.comments,"time",this.media.currentTime);this.position=Math.max(0,t-1);return this}function v(t){t.play=u.bind(this);t.pause=m.bind(this);t.seeking=p.bind(this);this.media.addEventListener("play",t.play);this.media.addEventListener("pause",t.pause);this.media.addEventListener("seeking",t.seeking)}function g(t){this.media.removeEventListener("play",t.play);this.media.removeEventListener("pause",t.pause);this.media.removeEventListener("seeking",t.seeking);t.play=null;t.pause=null;t.seeking=null}function w(t,i){var e=window.getComputedStyle(t,null).getPropertyValue("font-size").match(/(.+)px/)[1]*1;if(t.tagName==="HTML"){i.root=e}else{i.container=e}}function _(t){if(!/^(ltr|top|bottom)$/i.test(t)){return"rtl"}return t.toLowerCase()}function y(t){t.prototype.init=function(t){if(this._isInited){return this}if(!t||!t.container&&(!t.video||t.video&&!t.video.parentNode)){throw new Error("Danmaku requires container when initializing.")}this._hasInitContainer=!!t.container;this.container=t.container;this.visible=true;this.engine=(t.engine||"DOM").toLowerCase();this._useCanvas=this.engine==="canvas";this._requestID=0;this._speed=Math.max(0,t.speed)||144;this.duration=4;this.comments=JSON.parse(JSON.stringify(t.comments||[]));this.comments.sort(function(t,i){return t.time-i.time});for(var i=0;i<this.comments.length;i++){this.comments[i].mode=_(this.comments[i].mode)}this.runningList=[];this.position=0;this.paused=true;this.media=t.video||t.audio;this._hasMedia=!!this.media;this._hasVideo=!!t.video;if(this._hasVideo&&!this._hasInitContainer){var e=!this.media.paused;this.container=document.createElement("div");this.container.style.position=this.media.style.position;this.media.style.position="absolute";this.media.parentNode.insertBefore(this.container,this.media);this.container.appendChild(this.media);if(e&&this.media.paused){this.media.play()}}if(this._hasMedia){this._listener={};v.call(this,this._listener)}if(this._useCanvas){this.stage=document.createElement("canvas");this.stage.context=this.stage.getContext("2d")}else{this.stage=document.createElement("div");this.stage.style.cssText="overflow:hidden;white-space:nowrap;transform:translateZ(0);"}this.stage.style.cssText+="position:relative;pointer-events:none;";this.resize();this.container.appendChild(this.stage);this._space={};f(this._space);this._fontSize={root:16,container:16};w(document.getElementsByTagName("html")[0],this._fontSize);w(this.container,this._fontSize);if(!this._hasMedia||!this.media.paused){p.call(this);u.call(this)}this._isInited=true;return this}}var x=["mode","time","text","render","html","style","canvasStyle"];function b(t){t.prototype.emit=function(t){if(!t||Object.prototype.toString.call(t)!=="[object Object]"){return this}var i={};for(var e=0;e<x.length;e++){if(t[x[e]]!==undefined){i[x[e]]=t[x[e]]}}i.text=(i.text||"").toString();i.mode=_(i.mode);i._utc=Date.now()/1e3;if(this._hasMedia){var s=0;if(i.time===undefined){i.time=this.media.currentTime;s=this.position}else{s=l(this.comments,"time",i.time)}this.comments.splice(s,0,i)}else{this.comments.push(i)}return this}}function M(t){t.prototype.clear=function(){if(this._useCanvas){this.stage.context.clearRect(0,0,this.width,this.height);for(var t=0;t<this.runningList.length;t++){this.runningList[t].canvas=null}}else{var i=this.stage.lastChild;while(i){this.stage.removeChild(i);i=this.stage.lastChild}}this.runningList=[];return this}}function L(t){t.prototype.destroy=function(){if(!this._isInited){return this}m.call(this);this.clear();if(this._hasMedia){g.call(this,this._listener)}if(this._hasVideo&&!this._hasInitContainer){var t=!this.media.paused;this.media.style.position=this.container.style.position;this.container.parentNode.insertBefore(this.media,this.container);this.container.parentNode.removeChild(this.container);if(t&&this.media.paused){this.media.play()}}for(var i in this){if(Object.prototype.hasOwnProperty.call(this,i)){this[i]=null}}return this}}function C(t){t.prototype.show=function(){if(this.visible){return this}this.visible=true;if(this._hasMedia&&this.media.paused){return this}p.call(this);u.call(this);return this}}function T(t){t.prototype.hide=function(){if(!this.visible){return this}m.call(this);this.clear();this.visible=false;return this}}function k(t){t.prototype.resize=function(){if(this._hasInitContainer){this.width=this.container.offsetWidth;this.height=this.container.offsetHeight}if(this._hasVideo&&(!this._hasInitContainer||!this.width||!this.height)){this.width=this.media.clientWidth;this.height=this.media.clientHeight}if(this._useCanvas){this.stage.width=this.width;this.stage.height=this.height}else{this.stage.style.width=this.width+"px";this.stage.style.height=this.height+"px"}this.duration=this.width/this._speed;return this}}function E(t){Object.defineProperty(t.prototype,"speed",{get:function(){return this._speed},set:function(t){if(typeof t!=="number"||isNaN(t)||!isFinite(t)||t<=0){return this._speed}this._speed=t;if(this.width){this.duration=this.width/t}return t}})}function I(t){this._isInited=false;t&&this.init(t)}y(I);b(I);M(I);L(I);C(I);T(I);k(I);E(I);return I});